version: '3.9'
x-common-variables: &common-variables
  SQL_ENGINE: django.db.backends.postgresql
  SQL_DATABASE: devbb
  SQL_USER: devbb
  SQL_PASSWORD: devbb
  SQL_HOST: db
  SQL_PORT: 5432
  REDIS_HOST: redis
  MEDIA_ROOT: /media

x-healthcheck-defaults: &healthcheck-defaults
  interval: 10s
  timeout: 5s
  retries: 5

x-depends-on-defaults: &depends-on-defaults
  redis:
    condition: service_healthy
  db:
    condition: service_healthy
  wiwik_image:
    condition: service_completed_successfully


services:
  searchdb:
    image: getmeili/meilisearch:v1.4.1
    ports:
      - "7700:7700"
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-masterKey}
      - MEILI_NO_ANALYTICS=${MEILI_NO_ANALYTICS:-true}
      - MEILI_ENV=${MEILI_ENV:-development}
      - MEILI_DB_PATH=${MEILI_DB_PATH:-/data.ms}
    volumes:
      - "./data.ms:/data.ms"
    networks:
      - wiwik-network

  db:
    image: postgres:15-alpine
    volumes:
      - "./postgres_data/:/var/lib/postgresql/data/"
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: devbb
      POSTGRES_PASSWORD: devbb
      POSTGRES_DB: devbb
    healthcheck:
      <<: *healthcheck-defaults
      test: [ "CMD-SHELL", "pg_isready" ]
    networks:
      - wiwik-network

  redis:
    image: redis/redis-stack-server:7.2.0-v4
    ports:
      - "6379:6379"
    healthcheck:
      <<: *healthcheck-defaults
      test: [ "CMD", "redis-cli","ping" ]
    networks:
      - wiwik-network

  wiwik_image:
    image: wiwik_image
    command: [ 'echo', 'build completed' ]
    build:
      context: .
      dockerfile: Dockerfile

  wiwik_migrate:
    image: wiwik_image
    command: [ "python", "manage.py", "migrate" ]
    networks:
      - wiwik-network
    volumes:
      - ./forum/:/usr/src/app/
    env_file:
      - ./.env
    environment:
      <<: *common-variables
    depends_on:
      <<: *depends-on-defaults

  wiwik_populate_search:
    image: wiwik_image
    command: [ "python", "manage.py", "run_job", "populate_meilisearch" ]
    networks:
      - wiwik-network
    volumes:
      - ./forum/:/usr/src/app/
    env_file:
      - ./.env
    environment:
      <<: *common-variables
    depends_on:
      - wiwik_migrate

  wiwik_web:
    image: wiwik_image
    command: [ "python", "manage.py", "runserver", "0.0.0.0:8000" ]
    volumes:
      - ./forum/:/usr/src/app/
      - type: bind
        source: /Users/style/PycharmProjects/wiwik-insiders/forum/media
        target: /media
        volume:
          nocopy: true
    ports:
      - "8000:8000"
    networks:
      - wiwik-network
    env_file:
      - ./.env
    environment:
      <<: *common-variables
    depends_on:
      <<: *depends-on-defaults

  wiwik_worker: # Running all queues
    profiles:
      - worker
    image: wiwik_image
    command: [ "python", "manage.py", "rqworker", "cron", "default" ]
    #    command: [ "python", "manage.py", "rqworker", "--with-scheduler","cron", "default" ]
    volumes:
      - ./forum/:/usr/src/app/
    networks:
      - wiwik-network
    environment:
      <<: *common-variables
    depends_on:
      <<: *depends-on-defaults

networks:
  wiwik-network:
    driver: bridge

